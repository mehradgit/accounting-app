// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================================
// مدل‌های اصلی (حسابداری)
// ==========================================================

// ۱. حساب کل (AccountCategory)
model AccountCategory {
  id          Int               @id @default(autoincrement())
  code        String            @unique @db.VarChar(10)
  name        String            @db.VarChar(100)
  type        AccountType
  parentId    Int?
  parent      AccountCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    AccountCategory[] @relation("CategoryParent")
  subAccounts SubAccount[]
  createdAt   DateTime          @default(now())

  @@map("account_categories")
}

// ۲. حساب معین (SubAccount)
model SubAccount {
  id         Int             @id @default(autoincrement())
  code       String          @unique @db.VarChar(15)
  name       String          @db.VarChar(100)
  categoryId Int
  category   AccountCategory @relation(fields: [categoryId], references: [id])
  balance    Float           @default(0)

  detailAccounts DetailAccount[]
  voucherItems   VoucherItem[]
  drawerCheques  Cheque[]        @relation("ChequeDrawer")
  payeeCheques   Cheque[]        @relation("ChequePayee")

  createdAt DateTime @default(now())

  @@map("sub_accounts")
}

// ۳. حساب تفصیلی (DetailAccount)
model DetailAccount {
  id                 Int                 @id @default(autoincrement())
  code               String              @unique @db.VarChar(20)
  name               String              @db.VarChar(100)
  subAccountId       Int
  subAccount         SubAccount          @relation(fields: [subAccountId], references: [id])
  balance            Float               @default(0)
  inventoryDocuments InventoryDocument[]
  // ارتباط با Person (رابطه یک به یک اختیاری)
  person             Person?             @relation("DetailAccountPerson")

  // روابط چک‌ها
  drawerCheques  Cheque[] @relation("ChequeDrawerDetail")
  payeeCheques   Cheque[] @relation("ChequePayeeDetail")
  expenseCheques Cheque[] @relation("ChequeExpenseDetail")
  bankCheques    Cheque[] @relation("ChequeBankDetail")

  // روابط حسابداری
  voucherItems VoucherItem[]

  // روابط انبارداری
  products   Product[] // حساب تفصیلی کالاها
  warehouses Warehouse[] // حساب تفصیلی انبارها
  banks      Bank[] // حساب تفصیلی بانک‌ها

  createdAt DateTime @default(now())

  @@map("detail_accounts")
}

// ۴. شخص (Person)
model Person {
  id      Int        @id @default(autoincrement())
  name    String     @db.VarChar(100)
  type    PersonType
  phone   String?    @db.VarChar(20)
  email   String?    @db.VarChar(100)
  address String?

  // ارتباط با حساب تفصیلی (رابطه یک به یک)
  detailAccount   DetailAccount? @relation("DetailAccountPerson", fields: [detailAccountId], references: [id])
  detailAccountId Int?           @unique

  // روابط حسابداری
  voucherItems VoucherItem[]
  cheques      Cheque[]

  // روابط انبارداری
  inventoryDocuments InventoryDocument[]
  inventoryLedgers   InventoryLedger[]

  createdAt DateTime @default(now())

  @@map("persons")
}

// ۵. سند حسابداری (Voucher)
model Voucher {
  id                 Int                 @id @default(autoincrement())
  voucherNumber      String              @unique @db.VarChar(20)
  voucherDate        DateTime
  description        String?
  totalAmount        Float
  createdBy          Int?
  metadata           Json?               @db.Json
  // روابط
  items              VoucherItem[]
  cheques            Cheque[]
  inventoryDocuments InventoryDocument[]

  createdAt DateTime @default(now())

  @@map("vouchers")
}

// ۶. ردیف سند (VoucherItem)
model VoucherItem {
  id              Int            @id @default(autoincrement())
  voucherId       Int
  voucher         Voucher        @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  subAccountId    Int?
  subAccount      SubAccount?    @relation(fields: [subAccountId], references: [id])
  detailAccountId Int?
  detailAccount   DetailAccount? @relation(fields: [detailAccountId], references: [id])
  personId        Int?
  person          Person?        @relation(fields: [personId], references: [id])
  description     String?
  debit           Float          @default(0)
  credit          Float          @default(0)

  // روابط انبارداری
  inventoryLedgers InventoryLedger[]

  @@map("voucher_items")
}

// ۷. چک (Cheque)
model Cheque {
  id           Int          @id @default(autoincrement())
  chequeNumber String       @db.VarChar(50)
  bankName     String       @db.VarChar(100)
  branchName   String?      @db.VarChar(100)
  amount       Float
  issueDate    DateTime
  dueDate      DateTime
  drawer       String       @db.VarChar(100)
  payee        String?      @db.VarChar(100)
  type         ChequeType
  status       ChequeStatus @default(pending)
  description  String?
  issueReason  String?      @db.VarChar(20)

  // حساب‌های معین
  drawerAccountId Int?
  drawerAccount   SubAccount? @relation("ChequeDrawer", fields: [drawerAccountId], references: [id], onDelete: SetNull)
  payeeAccountId  Int?
  payeeAccount    SubAccount? @relation("ChequePayee", fields: [payeeAccountId], references: [id], onDelete: SetNull)

  // حساب‌های تفصیلی
  drawerDetailAccountId  Int?
  drawerDetailAccount    DetailAccount? @relation("ChequeDrawerDetail", fields: [drawerDetailAccountId], references: [id], onDelete: SetNull)
  payeeDetailAccountId   Int?
  payeeDetailAccount     DetailAccount? @relation("ChequePayeeDetail", fields: [payeeDetailAccountId], references: [id], onDelete: SetNull)
  bankDetailAccountId    Int?
  bankDetailAccount      DetailAccount? @relation("ChequeBankDetail", fields: [bankDetailAccountId], references: [id], onDelete: SetNull)
  expenseDetailAccountId Int?
  expenseDetailAccount   DetailAccount? @relation("ChequeExpenseDetail", fields: [expenseDetailAccountId], references: [id], onDelete: SetNull)

  // ارتباط با شخص
  personId Int?
  person   Person? @relation(fields: [personId], references: [id], onDelete: Cascade)

  // ارتباط با سند حسابداری
  voucherId Int?
  voucher   Voucher? @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chequeNumber, type])
  @@map("cheques")
}

// ۸. بانک (Bank)
model Bank {
  id              Int            @id @default(autoincrement())
  name            String         @db.VarChar(100)
  accountNumber   String?        @db.VarChar(50)
  balance         Float          @default(0)
  detailAccountId Int?
  detailAccount   DetailAccount? @relation(fields: [detailAccountId], references: [id])
  createdAt       DateTime       @default(now())

  @@map("banks")
}

// ==========================================================
// مدل‌های انبارداری (اصلاح شده)
// ==========================================================

// ۹. گروه کالا (ProductCategory)
model ProductCategory {
  id          Int               @id @default(autoincrement())
  code        String            @unique @db.VarChar(10)
  name        String            @db.VarChar(100)
  description String?
  parentId    Int?
  parent      ProductCategory?  @relation("ProductCategoryParent", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("ProductCategoryParent")
  products    Product[]
  createdAt   DateTime          @default(now())

  @@map("product_categories")
}

// ۱۰. واحد اندازه‌گیری (Unit)
model Unit {
  id          Int       @id @default(autoincrement())
  code        String    @unique @db.VarChar(10)
  name        String    @db.VarChar(50)
  description String?
  products    Product[]
  createdAt   DateTime  @default(now())

  @@map("units")
}

// ۱۱. کالا (Product)
model Product {
  id         Int             @id @default(autoincrement())
  code       String          @unique @db.VarChar(20)
  name       String          @db.VarChar(200)
  barcode    String?         @db.VarChar(50)
  categoryId Int
  category   ProductCategory @relation(fields: [categoryId], references: [id])
  unitId     Int
  unit       Unit            @relation(fields: [unitId], references: [id])

  // قیمت‌های پیش فرض
  defaultPurchasePrice  Float  @default(0)
  defaultSalePrice      Float  @default(0)
  defaultWholesalePrice Float?

  // محدودیت‌های موجودی
  minStock Float @default(0)
  maxStock Float @default(0)

  // حساب تفصیلی مربوطه
  detailAccountId Int?
  detailAccount   DetailAccount? @relation(fields: [detailAccountId], references: [id])

  // روابط
  priceHistory     ProductPriceHistory[]
  inventoryLedgers InventoryLedger[]
  stockItems       StockItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

// ۱۲. سابقه قیمت کالا (ProductPriceHistory)
model ProductPriceHistory {
  id             Int      @id @default(autoincrement())
  productId      Int
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  purchasePrice  Float
  salePrice      Float?
  wholesalePrice Float?
  effectiveDate  DateTime @default(now())
  createdAt      DateTime @default(now())

  @@map("product_price_history")
}

// ۱۳. انبار (Warehouse)
model Warehouse {
  id          Int     @id @default(autoincrement())
  code        String  @unique @db.VarChar(10)
  name        String  @db.VarChar(100)
  address     String?
  phone       String? @db.VarChar(20)
  manager     String? @db.VarChar(100)
  description String?

  // حساب تفصیلی مربوطه
  detailAccountId Int?
  detailAccount   DetailAccount? @relation(fields: [detailAccountId], references: [id])

  // روابط
  stockItems         StockItem[]
  inventoryLedgers   InventoryLedger[]
  inventoryDocuments InventoryDocument[]

  createdAt DateTime @default(now())

  @@map("warehouses")
}

// ۱۴. موجودی کالا در انبار (StockItem)
model StockItem {
  id          Int       @id @default(autoincrement())
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouseId Int
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  quantity    Float     @default(0)
  minStock    Float     @default(0)
  maxStock    Float     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, warehouseId])
  @@map("stock_items")
}

// ۱۵. نوع حرکت انبار (InventoryTransactionType)
model InventoryTransactionType {
  id                 Int                 @id @default(autoincrement())
  code               String              @unique @db.VarChar(20)
  name               String              @db.VarChar(100)
  effect             InventoryEffect
  description        String?
  inventoryDocuments InventoryDocument[]
  createdAt          DateTime            @default(now())

  @@map("inventory_transaction_types")
}

// ۱۶. سند انبار (InventoryDocument)
model InventoryDocument {
  id             Int                      @id @default(autoincrement())
  documentNumber String                   @unique @db.VarChar(20)
  documentDate   DateTime
  typeId         Int
  type           InventoryTransactionType @relation(fields: [typeId], references: [id])
  warehouseId    Int
  warehouse      Warehouse                @relation(fields: [warehouseId], references: [id])

  // این دو فیلد را نگه دارید (برای سازگاری)
  personId Int?
  person   Person? @relation(fields: [personId], references: [id])

  // این فیلد جدید
  detailAccountId Int?
  detailAccount   DetailAccount? @relation(fields: [detailAccountId], references: [id])

  voucherId Int?
  voucher   Voucher? @relation(fields: [voucherId], references: [id])

  referenceNumber String? @db.VarChar(50)
  description     String?
  totalQuantity   Float   @default(0)
  totalAmount     Float   @default(0)

  // روابط
  ledgerEntries InventoryLedger[]

  createdBy Int?
  createdAt DateTime @default(now())

  @@map("inventory_documents")
}

// ۱۷. کاردکس/سابقه کالا (InventoryLedger)
model InventoryLedger {
  id              Int               @id @default(autoincrement())
  documentId      Int
  document        InventoryDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouseId     Int
  warehouse       Warehouse         @relation(fields: [warehouseId], references: [id])
  transactionDate DateTime
  reference       String?           @db.VarChar(50)

  // مقادیر
  quantityIn  Float @default(0)
  quantityOut Float @default(0)
  unitPrice   Float @default(0)
  totalPrice  Float @default(0)

  // موجودی انباشته
  balanceQuantity Float @default(0)
  balanceValue    Float @default(0)

  // ارتباط با طرف حساب
  personId Int?
  person   Person? @relation(fields: [personId], references: [id])

  // ارتباط با سند حسابداری
  voucherItemId Int?
  voucherItem   VoucherItem? @relation(fields: [voucherItemId], references: [id], onDelete: SetNull)

  description String?

  // اضافه کردن metadata برای ذخیره اطلاعات اضافی
  metadata Json? @db.Json // <-- این خط را اضافه کنید

  createdBy Int?
  createdAt DateTime @default(now())

  @@index([productId, warehouseId, transactionDate])
  @@map("inventory_ledger")
}

// ۱۸. شمارنده اسناد انبار
model InventoryCounter {
  id         Int      @id @default(autoincrement())
  prefix     String   @db.VarChar(10)
  year       Int
  month      Int
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([prefix, year, month])
  @@map("inventory_counters")
}

// ==========================================================
// Enumها
// ==========================================================

enum AccountType {
  asset // دارایی
  liability // بدهی
  equity // سرمایه
  income // درآمد
  expense // هزینه
}

enum PersonType {
  customer // مشتری
  supplier // تامین کننده
  employee // کارمند
  other // سایر
}

enum ChequeType {
  receivable // دریافتنی
  payable // پرداختنی
}

enum ChequeStatus {
  pending // در انتظار
  collected // وصول شده
  deposited // در جریان وصول
  returned // برگشت خورده
  canceled // باطل شده
}

// اثر حرکت انبار
enum InventoryEffect {
  increase // افزایش موجودی
  decrease // کاهش موجودی
}
